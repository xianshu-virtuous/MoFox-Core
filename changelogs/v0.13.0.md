# 🎉 MoFox_Bot v0.13.0 正式版发布

<div align="center">

**🌊 心流革新 | 🧠 智能升级 | ⚡ 性能飞跃**

[![Version](https://img.shields.io/badge/version-0.13.0-blue.svg)](https://github.com/MoFox-Studio/MoFox-Core/releases/tag/v0.13.0)
[![Python](https://img.shields.io/badge/python-3.11+-blue?logo=python&logoColor=edb641)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-GPL--3.0-blue.svg)](LICENSE)

</div>

---

## 📖 版本概述

**MoFox_Bot v0.13.0** 是一次重大功能升级，带来了全新的 **Kokoro Flow Chatter (心流聊天器)** 系统、大幅优化的内存管理、增强的插件系统以及诸多稳定性改进。本次更新历经数月开发，包含 **1500+ 次提交**，为用户带来更自然、更智能、更高效的交互体验。

> 🌟 **重要提示**: 本版本完全重构了聊天处理逻辑，建议从 v0.12.x 升级的用户仔细阅读迁移指南。

---

## ✨ 核心亮点

### 🌊 Kokoro Flow Chatter (KFC) - 全新心流聊天系统

本版本的核心亮点是全新的 **Kokoro Flow Chatter** 聊天系统，从零开始构建，提供更自然、更人性化的对话体验。

- **V7 交互模型**: 引入全新的 V7 版本交互模型，支持中断机制和情感安全功能
- **中断处理机制**: 新消息可以中断正在进行的 LLM 处理，被中断的上下文会被保存并与新消息合并
- **情感安全系统**: 
  - AI 不会随意设置负面情绪状态
  - 情绪变化渐进式，强度变化有限制
  - 新增"情感健康检查"，在加载会话数据时自动清理不稳定状态
- **私聊专属处理**: 为私聊场景从零构建专属处理系统，提供更贴心的一对一交互
- **主动思考功能**: 为私人聊天实现主动思考，让对话更加智能和主动
- **模块化提示系统**: 实施提示管理系统，支持模块化提示生成
- **统一模式**: 整合统一模式，支持模块化提示生成

### 🧠 内存与性能优化 - 显著降低资源占用

- **LRU 缓存淘汰机制**: 添加 LRU 淘汰策略和缓存大小限制，优化内存使用
- **`__slots__` 优化**: 使用 `__slots__` 优化多个数据模型的内存占用和属性访问性能
- **分批查询优化**: 统计和查询模块实现分批处理，添加处理上限
- **单例模式优化**: `TypoGenerator` 实现单例模式，复用拼音字典和字频数据
- **内存监控模块**: 新增内存监控模块，支持内存使用追踪和日志记录

### 🔌 插件系统增强 - 更强大的扩展能力

- **组件查询与启禁功能**: 实现插件组件的查询与动态启用/禁用
- **API 模块化**: 将插件管理 API 拆分为更专注的模块，提高代码可维护性
- **组件状态管理**: 将组件状态管理逻辑提取到专职类中
- **权限 API 增强**: 增强权限 API 文档，添加详细注释和示例
- **适配器保护**: 禁止启用或禁用适配器类型组件，防止系统错误

### 📊 统计报告系统 - 全新可视化体验

- **ECharts 图表库**: 从 Chart.js 迁移到 ECharts，提供更丰富的可视化效果
- **现代化 UI 主题**: 引入全新现代化 UI 主题，采用 MD3 设计语言
- **高级可视化图表**: 增加多种高级可视化图表，包括模块花费分析
- **效率分析**: 新增效率分析功能，帮助用户了解系统性能
- **对数坐标轴**: 优化报告图表并引入对数坐标轴支持

### 🔧 开发体验提升

- **日志查看器**: 新增日志查看器功能，支持实时查看、搜索和筛选日志
- **死锁检测器**: 在 `StreamLoopManager` 中实现死锁检测机制
- **数据库迁移工具**: 增强数据库迁移工具，支持自动修复 PostgreSQL 问题
- **Gemini 支持**: 完善 Gemini 模型配置模板，添加 `thinking_level` 参数支持

---

## 🆕 重要新功能

### 心流与对话系统
- ✅ Kokoro Flow Chatter V7 交互模型完整实现
- ✅ 私聊专属处理系统
- ✅ 中断机制和情感安全功能
- ✅ 主动思考配置选项
- ✅ 私聊必回功能
- ✅ 超时决策上下文优化
- ✅ 连续超时计数和用户最后回复时间追踪

### 记忆与上下文
- ✅ 为 LLM 提供过去网页搜索的上下文记忆
- ✅ 记忆块构建逻辑更新，添加查询文本获取策略
- ✅ 消息摘要提取功能
- ✅ 安全互动准则块增强用户交互安全性

### 表情与交互
- ✅ 表情回应动作群聊检查
- ✅ 表情包注册时描述生成的异步处理优化
- ✅ 提取精炼描述的辅助函数
- ✅ 消息上下文下的表情选择增强

### 工具与服务
- ✅ Exa 引擎迁移到 `search_and_contents` API
- ✅ 用户分析工具重构，实现更严格的现实分析
- ✅ 用户关系和分析系统重构，采用结构化数据和异步更新

### 配置与管理
- ✅ 群组静音功能
- ✅ 无意义消息过滤功能优化表达学习效果
- ✅ 聊天流配置解析和共享组训练支持

---

## 🔧 重要修复

### 核心系统
- 🐛 修复 Chatter 处理标志的假死状态并增强并发保护
- 🐛 防止 Chatter 和 ProactiveThinker 之间的竞争条件
- 🐛 修复 aiosqlite 日志导致 CPU 占用过高的问题
- 🐛 修复全局封禁用户列表的用户 ID 处理方式

### 数据库与缓存
- 🐛 更新数据库会话管理，确保事务安全
- 🐛 修复数据迁移中的事务处理
- 🐛 移除迁移数据中的 NUL 字符
- 🐛 修复返回的 embedding 为空时的处理逻辑

### 插件系统
- 🐛 修复系统命令执行时缺失用户信息的错误处理
- 🐛 禁止启用或禁用适配器类型组件
- 🐛 修复组件移除时的错误处理逻辑

### 聊天与回复
- 🐛 修复 Focus 模式下的回复动作处理逻辑
- 🐛 修复回复后阈值调整逻辑
- 🐛 为 reply_to 提供回退以防止崩溃
- 🐛 修复报告图表懒加载时的函数调用问题

### 模型与工具
- 🐛 调整 Gemini safetySettings 参数至 API 请求的正确层级
- 🐛 修复模型工具中的类型问题并增加断言
- 🐛 修复抗审查指令被无条件添加的问题

---

## 🔄 重大重构

### 架构层面
- ♻️ Kokoro Flow Chatter 完全重写，从 V1 升级到 V7
- ♻️ 插件系统 API 模块化重构
- ♻️ 组件注册中心全面改造，增加本地状态管理
- ♻️ 统一调度器适配器迁移

### 功能模块
- ♻️ 用户分析工具重构，实现更严格的现实分析
- ♻️ Exa 搜索引擎迁移到新 API
- ♻️ 数据库消息表移除自增主键字段
- ♻️ 消息处理器中移除冗余消息类型定义

### 代码质量
- ♻️ 提高配置访问安全性
- ♻️ 简化配置文件模板，移除废弃配置
- ♻️ 废弃旧版 Command 系统并重构注册中心
- ♻️ 统一插件卸载逻辑到注册中心

---

## ⚙️ 配置变更

### 新增配置项
- `[kokoro_flow_chatter]` - KFC 心流聊天器配置
- `[proactive_thinking]` - 主动思考功能配置
- 内存监控相关配置
- 缓存大小限制配置

### 配置模板更新
- `bot_config.toml` 简化，移除废弃的跨上下文配置
- `model_config.toml` 完善 Gemini 模型配置

### 移除的配置项
- 移除废弃的跨上下文配置
- 移除通用共享组模式相关配置

---

## 🔄 迁移指南

### 从 0.12.x 升级到 0.13.0

#### 1. 依赖更新
```bash
# 使用 uv（推荐）
uv pip install -r requirements.txt

# 或使用 pip
pip install -r requirements.txt
```

#### 2. 配置文件更新
- 检查 `bot_config.toml` 中的新增配置项
- 移除已废弃的跨上下文配置
- 更新 Gemini 模型配置（如有使用）

#### 3. 插件兼容性检查
- 检查自定义插件是否使用了新的 API
- 更新使用旧版 Command 系统的插件
- 测试插件功能是否正常

### 破坏性变更

⚠️ **注意**: 以下变更可能影响现有配置或插件

1. **Kokoro Flow Chatter 重构**
   - 旧的 KFC 配置需要更新
   - 私聊处理逻辑完全重写

2. **插件系统 API 变更**
   - 部分 API 已模块化拆分
   - 旧版 Command 系统已废弃

3. **数据库表结构变更**
   - 消息表移除自增主键字段
   - 需要运行数据迁移脚本

---

## 🚀 性能提升

### 优化亮点
- ✨ LRU 缓存淘汰减少内存占用 30%
- ✨ `__slots__` 优化减少对象内存占用
- ✨ 分批查询避免大数据量时的 OOM
- ✨ 单例模式复用减少重复初始化
- ✨ 死锁检测提升系统稳定性

---

## 🙏 致谢

感谢所有为 MoFox_Bot v0.13.0 做出贡献的开发者和社区成员！

### 主要贡献者
- [@MoFox-Studio](https://github.com/MoFox-Studio) - 核心开发团队
- [@Windpicker-owo](https://github.com/Windpicker-owo) - 核心功能开发
- [@mcn1630](https://github.com/mcn1630) - 贡献 TTS 和空间生图功能
- 所有提交 Issue 和 PR 的社区成员

### 开源项目
- [MaiBot](https://github.com/MaiM-with-u/MaiBot) - 提供核心架构基础
- [NapCatQQ](https://github.com/NapNeko/NapCatQQ) - 提供 QQ 协议支持
- [SQLAlchemy](https://www.sqlalchemy.org/) - 强大的 ORM 框架
- [ECharts](https://echarts.apache.org/) - 数据可视化图表库

---

## 🐛 已知问题

1. **私聊必回**: 在某些边缘情况下可能导致重复回复
2. **KFC 中断机制**: 频繁消息可能导致上下文过长
3. **内存监控**: 在低内存环境下可能影响性能

---

## 📞 获取帮助

- 📖 **文档**: [https://mofox-studio.github.io/MoFox-Bot-Docs/](https://mofox-studio.github.io/MoFox-Bot-Docs/)
- 💬 **QQ 群**: [墨狐狐的大学 (169850076)](https://qm.qq.com/q/YwZTZl7BG8) | [墨狐狐技术部 (1064097634)](https://qm.qq.com/q/Lmm1LZnewg)
- 🐛 **问题反馈**: [GitHub Issues](https://github.com/MoFox-Studio/MoFox-Core/issues)
- 📧 **联系我们**: [GitHub Discussions](https://github.com/MoFox-Studio/MoFox-Core/discussions)

---

## ⚖️ 开源协议

本项目基于 **GPL-3.0** 协议开源。详见 [LICENSE](LICENSE) 文件。

---

<div align="center">

**🌟 如果这个项目对你有帮助，请给我们一个 Star！**

**Made with ❤️ by [MoFox Studio](https://github.com/MoFox-Studio)**

</div>
